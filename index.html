<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D飞行预览</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            padding: 12px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.active {
            background: #FF3B30;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
        }
        
        .info-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: 500;
        }
        
        .info-value {
            color: #FFD700;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: #FF3B30;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <!-- 加载提示 -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>正在加载3D场景...</div>
    </div>
    
    <!-- 错误提示 -->
    <div id="error" class="error" style="display: none;">
        <div>加载失败，请检查网络连接</div>
        <button class="control-btn" onclick="location.reload()" style="margin-top: 10px;">重新加载</button>
    </div>
    
    <!-- 控制面板 -->
    <div class="controls">
        <button class="control-btn" id="playBtn" onclick="toggleFlight()">开始飞行</button>
        <button class="control-btn" onclick="resetView()">重置视角</button>
        <button class="control-btn" onclick="toggleView()">切换视角</button>
        <button class="control-btn" onclick="toggleSpeed()">调整速度</button>
    </div>
    
    <!-- 信息面板 -->
    <div class="info-panel">
        <div class="info-item">
            <span class="info-label">飞行状态:</span>
            <span class="info-value" id="flightStatus">准备中</span>
        </div>
        <div class="info-item">
            <span class="info-label">当前航点:</span>
            <span class="info-value" id="currentWaypoint">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">飞行高度:</span>
            <span class="info-value" id="altitude">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">飞行速度:</span>
            <span class="info-value" id="speed">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">剩余时间:</span>
            <span class="info-value" id="remainingTime">-</span>
        </div>
    </div>
    
    <!-- 腾讯地图API -->
    <script src="https://map.qq.com/api/gljs?v=1.exp&key=D7BBZ-XDF3B-GULUK-NKGB2-2LFJQ-HDFTS&libraries=model"></script>
    
    <script>
        // 全局变量
        let map = null;
        let Tileset3D = null;
        let flightPath = null;
        let waypointMarkers = [];
        let droneMarker = null;
        let isPlaying = false;
        let currentView = 'god'; // god, follow, fpv
        let speedLevel = 1; // 1: 正常, 2: 快速, 0.5: 慢速
        let flightTimer = null;
        let currentWaypointIndex = 0;
        let routeData = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取路线数据
            const urlParams = new URLSearchParams(window.location.search);
            const routeDataStr = urlParams.get('routeData');
            
            if (routeDataStr) {
                try {
                    routeData = JSON.parse(decodeURIComponent(routeDataStr));
                    console.log('Route data loaded:', routeData);
                } catch (e) {
                    console.error('Failed to parse route data:', e);
                    showError('路线数据解析失败');
                    return;
                }
            } else {
                 // 使用默认测试数据（3DTiles模型覆盖区域）
                 routeData = {
                     waypoints: [
                         { latitude: 35.09260704247744, longitude: 111.06575713601103, altitude: 100, name: '起点' },
                         { latitude: 35.093, longitude: 111.066, altitude: 120, name: '航点1' },
                         { latitude: 35.094, longitude: 111.067, altitude: 110, name: '航点2' },
                         { latitude: 35.095, longitude: 111.068, altitude: 130, name: '终点' }
                     ],
                     routeName: '测试飞行路线'
                 };
            }
            
            // 初始化地图
            initMap();
        });
        
         // 初始化地图
         function initMap() {
             try {
                 // 设置地图中心点（3DTiles模型覆盖区域）
                 let center = new TMap.LatLng(35.09260704247744, 111.06575713601103);
                 
                 // 如果有航点数据，使用第一个航点作为中心
                 if (routeData.waypoints && routeData.waypoints.length > 0) {
                     const firstWaypoint = routeData.waypoints[0];
                     center = new TMap.LatLng(firstWaypoint.latitude, firstWaypoint.longitude);
                 }
                
                // 创建地图
                map = new TMap.Map("container", {
                    rotation: 0,
                    pitch: 45, // 3D视角
                    zoom: 16,
                    center: center,
                    baseMap: {
                        type: "vector",
                        features: ["base", "building3d"]
                    }
                });
                
                // 地图加载完成后添加3D建筑和路径
                map.on('tilesloaded', function() {
                    add3DBuildings();
                    addFlightPath();
                    hideLoading();
                });
                
                // 地图加载失败处理
                map.on('error', function(e) {
                    console.error('Map load error:', e);
                    showError('地图加载失败，请检查网络连接');
                });
                
            } catch (error) {
                console.error('Failed to initialize map:', error);
                showError('地图初始化失败：' + error.message);
            }
        }
        
        // 添加3D建筑
        function add3DBuildings() {
            try {
                Tileset3D = new TMap.model.Tileset3D({
                    id: 'Tileset3DLayer',
                    url: 'https://mapapi.qq.com/web/lbs/visualizationApi/demo/data/3dTilesGCJ02/tileset.json',
                    map: map,
                    offset: [0, 0, 0]
                });
                console.log('3D buildings added');
            } catch (error) {
                console.error('Failed to add 3D buildings:', error);
            }
        }
        
        // 添加飞行路径
        function addFlightPath() {
            if (!routeData.waypoints || routeData.waypoints.length < 2) {
                console.log('Not enough waypoints for flight path');
                return;
            }
            
            try {
                // 创建路径点
                const pathPoints = routeData.waypoints.map(wp => 
                    new TMap.LatLng(wp.latitude, wp.longitude)
                );
                
                // 创建路径线
                flightPath = new TMap.MultiPolyline({
                    id: 'flightPath',
                    map: map,
                    styles: {
                        'path': new TMap.PolylineStyle({
                            color: '#FFD700',
                            width: 4
                        })
                    },
                    geometries: [{
                        id: 'path',
                        styleId: 'path',
                        paths: pathPoints
                    }]
                });
                
                // 添加航点标记
                addWaypointMarkers();
                
                // 添加无人机标记
                addDroneMarker();
                
                console.log('Flight path added with', routeData.waypoints.length, 'waypoints');
                
            } catch (error) {
                console.error('Failed to add flight path:', error);
            }
        }
        
        // 添加航点标记
        function addWaypointMarkers() {
            routeData.waypoints.forEach((wp, index) => {
                const marker = new TMap.MultiMarker({
                    id: `waypoint_${index}`,
                    map: map,
                    styles: {
                        'waypoint': new TMap.MarkerStyle({
                            width: 30,
                            height: 30,
                            anchor: { x: 15, y: 15 },
                            src: createWaypointIcon(index + 1)
                        })
                    },
                    geometries: [{
                        id: `wp_${index}`,
                        styleId: 'waypoint',
                        position: new TMap.LatLng(wp.latitude, wp.longitude)
                    }]
                });
                
                waypointMarkers.push(marker);
            });
        }
        
        // 创建航点图标
        function createWaypointIcon(number) {
            const svg = `
                <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="15" cy="15" r="12" fill="#FF3B30" stroke="white" stroke-width="2"/>
                    <text x="15" y="20" font-family="Arial" font-size="12" fill="white" text-anchor="middle">${number}</text>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }
        
        // 添加无人机标记
        function addDroneMarker() {
            if (routeData.waypoints.length === 0) return;
            
            const firstWaypoint = routeData.waypoints[0];
            droneMarker = new TMap.MultiMarker({
                id: 'drone',
                map: map,
                styles: {
                    'drone': new TMap.MarkerStyle({
                        width: 25,
                        height: 25,
                        anchor: { x: 12.5, y: 12.5 },
                        src: createDroneIcon()
                    })
                },
                geometries: [{
                    id: 'drone_marker',
                    styleId: 'drone',
                    position: new TMap.LatLng(firstWaypoint.latitude, firstWaypoint.longitude)
                }]
            });
        }
        
        // 创建无人机图标
        function createDroneIcon() {
            const svg = `
                <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12.5" cy="12.5" r="10" fill="#007AFF" stroke="white" stroke-width="2"/>
                    <path d="M8 8L17 17M17 8L8 17" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }
        
        // 切换飞行状态
        function toggleFlight() {
            if (isPlaying) {
                pauseFlight();
            } else {
                startFlight();
            }
        }
        
        // 开始飞行
        function startFlight() {
            if (!routeData.waypoints || routeData.waypoints.length < 2) {
                alert('航点数量不足，无法开始飞行');
                return;
            }
            
            isPlaying = true;
            currentWaypointIndex = 0;
            
            document.getElementById('playBtn').textContent = '暂停飞行';
            document.getElementById('playBtn').classList.add('active');
            document.getElementById('flightStatus').textContent = '飞行中';
            
            // 开始飞行动画
            startFlightAnimation();
            
            console.log('Flight started');
        }
        
        // 暂停飞行
        function pauseFlight() {
            isPlaying = false;
            
            document.getElementById('playBtn').textContent = '开始飞行';
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('flightStatus').textContent = '已暂停';
            
            if (flightTimer) {
                clearInterval(flightTimer);
                flightTimer = null;
            }
            
            console.log('Flight paused');
        }
        
        // 开始飞行动画
        function startFlightAnimation() {
            const totalWaypoints = routeData.waypoints.length;
            const flightDuration = totalWaypoints * 3 * 1000; // 每个航点3秒
            const interval = 100; // 更新间隔100ms
            
            let progress = 0;
            
            flightTimer = setInterval(() => {
                if (!isPlaying) return;
                
                progress += interval;
                const totalProgress = progress / flightDuration;
                
                if (totalProgress >= 1) {
                    // 飞行完成
                    completeFlight();
                    return;
                }
                
                // 计算当前航点索引
                const waypointProgress = totalProgress * (totalWaypoints - 1);
                const currentIndex = Math.floor(waypointProgress);
                const nextIndex = Math.min(currentIndex + 1, totalWaypoints - 1);
                const segmentProgress = waypointProgress - currentIndex;
                
                // 更新无人机位置
                updateDronePosition(currentIndex, nextIndex, segmentProgress);
                
                // 更新信息面板
                updateFlightInfo(currentIndex, segmentProgress);
                
            }, interval);
        }
        
        // 更新无人机位置
        function updateDronePosition(currentIndex, nextIndex, segmentProgress) {
            if (!droneMarker || !routeData.waypoints) return;
            
            const currentWp = routeData.waypoints[currentIndex];
            const nextWp = routeData.waypoints[nextIndex];
            
            // 插值计算当前位置
            const lat = currentWp.latitude + (nextWp.latitude - currentWp.latitude) * segmentProgress;
            const lng = currentWp.longitude + (nextWp.longitude - currentWp.longitude) * segmentProgress;
            const alt = currentWp.altitude + (nextWp.altitude - currentWp.altitude) * segmentProgress;
            
            // 更新无人机位置
            droneMarker.setGeometries([{
                id: 'drone_marker',
                styleId: 'drone',
                position: new TMap.LatLng(lat, lng)
            }]);
            
            // 更新摄像机视角
            if (currentView === 'follow') {
                map.setCenter(new TMap.LatLng(lat, lng));
            }
        }
        
        // 更新飞行信息
        function updateFlightInfo(currentIndex, segmentProgress) {
            const currentWp = routeData.waypoints[currentIndex];
            const nextWp = routeData.waypoints[Math.min(currentIndex + 1, routeData.waypoints.length - 1)];
            
            // 计算当前高度
            const altitude = currentWp.altitude + (nextWp.altitude - currentWp.altitude) * segmentProgress;
            
            // 计算飞行速度
            const speed = 15 * speedLevel; // 基础速度15m/s
            
            // 计算剩余时间
            const remainingWaypoints = routeData.waypoints.length - currentIndex - 1;
            const remainingTime = remainingWaypoints * 3 / speedLevel; // 每个航点3秒
            
            // 更新UI
            document.getElementById('currentWaypoint').textContent = `${currentIndex + 1}/${routeData.waypoints.length}`;
            document.getElementById('altitude').textContent = `${Math.round(altitude)}m`;
            document.getElementById('speed').textContent = `${Math.round(speed)}m/s`;
            document.getElementById('remainingTime').textContent = `${Math.round(remainingTime)}s`;
        }
        
        // 完成飞行
        function completeFlight() {
            isPlaying = false;
            
            document.getElementById('playBtn').textContent = '重新飞行';
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('flightStatus').textContent = '飞行完成';
            
            if (flightTimer) {
                clearInterval(flightTimer);
                flightTimer = null;
            }
            
            // 显示完成提示
            setTimeout(() => {
                alert('飞行预览完成！');
            }, 500);
            
            console.log('Flight completed');
        }
        
        // 重置视角
        function resetView() {
            if (!map) return;
            
             const center = routeData.waypoints && routeData.waypoints.length > 0 
                 ? new TMap.LatLng(routeData.waypoints[0].latitude, routeData.waypoints[0].longitude)
                 : new TMap.LatLng(35.09260704247744, 111.06575713601103);
            
            map.setCenter(center);
            map.setZoom(16);
            map.setPitch(45);
            map.setRotation(0);
            
            console.log('View reset');
        }
        
        // 切换视角
        function toggleView() {
            if (!map) return;
            
            switch (currentView) {
                case 'god':
                    currentView = 'follow';
                    map.setPitch(30);
                    console.log('Switched to follow view');
                    break;
                case 'follow':
                    currentView = 'fpv';
                    map.setPitch(0);
                    console.log('Switched to FPV view');
                    break;
                case 'fpv':
                    currentView = 'god';
                    map.setPitch(45);
                    console.log('Switched to god view');
                    break;
            }
        }
        
        // 调整速度
        function toggleSpeed() {
            switch (speedLevel) {
                case 1:
                    speedLevel = 2;
                    console.log('Speed: Fast (2x)');
                    break;
                case 2:
                    speedLevel = 0.5;
                    console.log('Speed: Slow (0.5x)');
                    break;
                case 0.5:
                    speedLevel = 1;
                    console.log('Speed: Normal (1x)');
                    break;
            }
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('div').textContent = message;
        }
        
        // 隐藏加载
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (flightTimer) {
                clearInterval(flightTimer);
            }
        });
    </script>
</body>
</html>

