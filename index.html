<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D飞行预览</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            padding: 12px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.active {
            background: #FF3B30;
        }
        
        .mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 5px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #555;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .mode-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .mode-btn.active {
            background: #007AFF;
            border-color: #007AFF;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
        }
        
        .info-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: 500;
        }
        
        .info-value {
            color: #FFD700;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: #FF3B30;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
        }
        
        .waypoints-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            max-height: 400px;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #fff;
        }
        
        .waypoint-count {
            font-size: 12px;
            color: #ccc;
        }
        
        .waypoints-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .waypoint-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .waypoint-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .waypoint-item:last-child {
            margin-bottom: 0;
        }
        
        .waypoint-number {
            width: 30px;
            height: 30px;
            background: #007AFF;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .waypoint-info {
            flex: 1;
            min-width: 0;
        }
        
        .waypoint-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .waypoint-coords {
            font-size: 12px;
            color: #ccc;
            display: block;
            margin-bottom: 2px;
        }
        
        .waypoint-altitude {
            font-size: 12px;
            color: #34C759;
            font-weight: bold;
        }
        
        .waypoint-delete {
            color: #FF3B30;
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid #FF3B30;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .waypoint-delete:hover {
            background: #FF3B30;
            color: white;
        }
        
        .route-info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 250px;
            z-index: 1000;
        }
        
        .route-info-content {
            margin-top: 10px;
        }
        
        .route-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .route-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #ccc;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
            color: #34C759;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <!-- 加载提示 -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>正在加载3D场景...</div>
    </div>
    
    <!-- 错误提示 -->
    <div id="error" class="error" style="display: none;">
        <div>加载失败，请检查网络连接</div>
        <button class="control-btn" onclick="location.reload()" style="margin-top: 10px;">重新加载</button>
    </div>
    
    <!-- 模式切换按钮 -->
    <div class="mode-toggle">
        <button id="editModeBtn" class="mode-btn active" onclick="switchToEditMode()">编辑模式</button>
        <button id="previewModeBtn" class="mode-btn" onclick="switchToPreviewMode()">预览模式</button>
    </div>

    <!-- 控制面板 -->
    <div class="controls">
        <!-- 编辑模式控制 -->
        <div id="editControls" style="display: none;">
            <button class="control-btn" onclick="addWaypoint()">添加航点</button>
            <button class="control-btn" onclick="clearWaypoints()">清空航点</button>
            <button class="control-btn" onclick="finishEditing()" style="background: #34C759;">完成编辑</button>
        </div>
        
        <!-- 预览模式控制 -->
        <div id="previewControls">
            <button class="control-btn" id="playBtn" onclick="toggleFlight()">开始飞行</button>
            <button class="control-btn" onclick="resetView()">重置视角</button>
            <button class="control-btn" onclick="toggleView()">切换视角</button>
            <button class="control-btn" onclick="toggleSpeed()">调整速度</button>
        </div>
    </div>
    
    <!-- 编辑模式信息面板 -->
    <div class="info-panel" id="editInfoPanel" style="display: none;">
        <div class="panel-header">
            <h3>路线信息</h3>
        </div>
        <div class="route-info-content">
            <div class="route-name" id="routeName">未命名路线</div>
            <div class="route-stats">
                <div class="stat-item">
                    <span class="stat-label">航点数量:</span>
                    <span class="stat-value" id="routeWaypointCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">总距离:</span>
                    <span class="stat-value" id="routeDistance">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">预计时长:</span>
                    <span class="stat-value" id="routeDuration">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预览模式信息面板 -->
    <div class="info-panel" id="previewInfoPanel" style="display: none;">
        <div class="info-item">
            <span class="info-label">飞行状态:</span>
            <span class="info-value" id="flightStatus">准备中</span>
        </div>
        <div class="info-item">
            <span class="info-label">当前航点:</span>
            <span class="info-value" id="currentWaypoint">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">飞行高度:</span>
            <span class="info-value" id="altitude">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">飞行速度:</span>
            <span class="info-value" id="speed">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">剩余时间:</span>
            <span class="info-value" id="remainingTime">-</span>
        </div>
    </div>
    
    <!-- 航点列表面板 -->
    <div class="waypoints-panel" id="waypointsPanel">
        <div class="panel-header">
            <h3>航点列表</h3>
            <span class="waypoint-count" id="waypointCount">共0个航点</span>
        </div>
        <div class="waypoints-list" id="waypointsList">
            <!-- 航点列表将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 腾讯地图API -->
    <script src="https://map.qq.com/api/gljs?v=1.exp&key=D7BBZ-XDF3B-GULUK-NKGB2-2LFJQ-HDFTS&libraries=model"></script>
    
    <script>
        // 全局变量
        let map = null;
        let Tileset3D = null;
        let flightPath = null;
        let waypointMarkers = [];
        let droneMarker = null;
        let isPlaying = false;
        let currentView = 'god'; // god, follow, fpv
        let speedLevel = 1; // 1: 正常, 2: 快速, 0.5: 慢速
        let flightTimer = null;
        let currentWaypointIndex = 0;
        let routeData = null;
        
        // 编辑模式相关变量
        let editMode = false;
        let waypoints = [];
        let editingWaypoint = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const routeDataStr = urlParams.get('routeData');
            const editModeParam = urlParams.get('editMode');
            
            // 检查是否为编辑模式
            editMode = editModeParam === 'true';
            console.log('HTML: editModeParam =', editModeParam);
            console.log('HTML: editMode =', editMode);
            
            if (editMode) {
                // 编辑模式：检查是否有现有路线数据
                if (routeDataStr) {
                    // 编辑现有路线
                    try {
                        routeData = JSON.parse(decodeURIComponent(routeDataStr));
                        waypoints = routeData.waypoints || [];
                        console.log('Edit existing route:', routeData);
                    } catch (e) {
                        console.error('Failed to parse existing route data:', e);
                        // 如果解析失败，创建新路线
                        routeData = {
                            waypoints: [],
                            routeName: '自定义3D路线'
                        };
                        waypoints = [];
                    }
                } else {
                    // 创建新路线
                    routeData = {
                        waypoints: [],
                        routeName: '自定义3D路线'
                    };
                    waypoints = [];
                }
                updateEditControls();
                updateModeUI();
            } else if (routeDataStr) {
                // 预览模式：加载现有路线数据
                try {
                    routeData = JSON.parse(decodeURIComponent(routeDataStr));
                    waypoints = routeData.waypoints || [];
                    console.log('Route data loaded:', routeData);
                } catch (e) {
                    console.error('Failed to parse route data:', e);
                    showError('路线数据解析失败');
                    return;
                }
            } else {
                // 没有路线数据，初始化空路线
                routeData = {
                    waypoints: [],
                    routeName: '未命名路线'
                };
                waypoints = [];
            }
            
            // 更新模式UI
            updateModeUI();
            
            // 初始化地图
            initMap();
        });
        
         // 初始化地图
         function initMap() {
             try {
                 // 设置地图中心点（3DTiles模型覆盖区域）
                 let center = new TMap.LatLng(35.09260704247744, 111.06575713601103);
                 
                 // 如果有航点数据，使用第一个航点作为中心
                 if (routeData.waypoints && routeData.waypoints.length > 0) {
                     const firstWaypoint = routeData.waypoints[0];
                     center = new TMap.LatLng(firstWaypoint.latitude, firstWaypoint.longitude);
                 }
                
                // 创建地图
                map = new TMap.Map("container", {
                    rotation: 0,
                    pitch: 45, // 3D视角
                    zoom: 16,
                    center: center,
                    baseMap: {
                        type: "vector",
                        features: ["base", "building3d"]
                    }
                });
                
                // 地图加载完成后添加3D建筑和路径
                map.on('tilesloaded', function() {
                    add3DBuildings();
                    if (editMode) {
                        // 编辑模式：显示现有航点
                        addExistingWaypoints();
                    } else {
                        // 预览模式：显示飞行路径
                        addFlightPath();
                        addWaypointMarkers();
                    }
                    // 更新航点列表（两种模式都需要）
                    updateWaypointsList();
                    
                    // 更新路线信息
                    updateRouteInfo();
                    
                    hideLoading();
                });
                
                // 地图加载失败处理
                map.on('error', function(e) {
                    console.error('Map load error:', e);
                    showError('地图加载失败，请检查网络连接');
                });
                
            } catch (error) {
                console.error('Failed to initialize map:', error);
                showError('地图初始化失败：' + error.message);
            }
        }
        
        // 添加3D建筑
        function add3DBuildings() {
            try {
                Tileset3D = new TMap.model.Tileset3D({
                    id: 'Tileset3DLayer',
                    url: 'https://mapapi.qq.com/web/lbs/visualizationApi/demo/data/3dTilesGCJ02/tileset.json',
                    map: map,
                    offset: [0, 0, 0]
                });
                console.log('3D buildings added');
            } catch (error) {
                console.error('Failed to add 3D buildings:', error);
            }
        }
        
        // 添加飞行路径
        function addFlightPath() {
            if (!routeData.waypoints || routeData.waypoints.length < 2) {
                console.log('Not enough waypoints for flight path');
                return;
            }
            
            try {
                // 创建路径点
                const pathPoints = routeData.waypoints.map(wp => 
                    new TMap.LatLng(wp.latitude, wp.longitude)
                );
                
                // 创建路径线
                flightPath = new TMap.MultiPolyline({
                    id: 'flightPath',
                    map: map,
                    styles: {
                        'path': new TMap.PolylineStyle({
                            color: '#FFD700',
                            width: 4
                        })
                    },
                    geometries: [{
                        id: 'path',
                        styleId: 'path',
                        paths: pathPoints
                    }]
                });
                
                // 添加航点标记
                addWaypointMarkers();
                
                // 添加无人机标记
                addDroneMarker();
                
                console.log('Flight path added with', routeData.waypoints.length, 'waypoints');
                
            } catch (error) {
                console.error('Failed to add flight path:', error);
            }
        }
        
        // 添加航点标记
        function addWaypointMarkers() {
            routeData.waypoints.forEach((wp, index) => {
                const marker = new TMap.MultiMarker({
                    id: `waypoint_${index}`,
                    map: map,
                    styles: {
                        'waypoint': new TMap.MarkerStyle({
                            width: 30,
                            height: 30,
                            anchor: { x: 15, y: 15 },
                            src: createWaypointIcon(index + 1)
                        })
                    },
                    geometries: [{
                        id: `wp_${index}`,
                        styleId: 'waypoint',
                        position: new TMap.LatLng(wp.latitude, wp.longitude)
                    }]
                });
                
                waypointMarkers.push(marker);
            });
        }
        
        // 创建航点图标
        function createWaypointIcon(number) {
            const svg = `
                <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="15" cy="15" r="12" fill="#FF3B30" stroke="white" stroke-width="2"/>
                    <text x="15" y="20" font-family="Arial" font-size="12" fill="white" text-anchor="middle">${number}</text>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }
        
        // 添加无人机标记
        function addDroneMarker() {
            if (routeData.waypoints.length === 0) return;
            
            const firstWaypoint = routeData.waypoints[0];
            droneMarker = new TMap.MultiMarker({
                id: 'drone',
                map: map,
                styles: {
                    'drone': new TMap.MarkerStyle({
                        width: 30,
                        height: 30,
                        anchor: { x: 15, y: 15 },
                        src: createDroneIcon()
                    })
                },
                geometries: [{
                    id: 'drone_marker',
                    styleId: 'drone',
                    position: new TMap.LatLng(firstWaypoint.latitude, firstWaypoint.longitude)
                }]
            });
        }
        
        // 创建无人机图标
        function createDroneIcon() {
            const svg = `
                <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- 无人机主体 -->
                    <ellipse cx="15" cy="15" rx="8" ry="4" fill="#FF6B35" stroke="white" stroke-width="1.5"/>
                    <!-- 螺旋桨臂 -->
                    <line x1="8" y1="15" x2="22" y2="15" stroke="white" stroke-width="2"/>
                    <line x1="15" y1="8" x2="15" y2="22" stroke="white" stroke-width="2"/>
                    <!-- 螺旋桨 -->
                    <circle cx="8" cy="15" r="3" fill="none" stroke="white" stroke-width="1.5"/>
                    <circle cx="22" cy="15" r="3" fill="none" stroke="white" stroke-width="1.5"/>
                    <circle cx="15" cy="8" r="3" fill="none" stroke="white" stroke-width="1.5"/>
                    <circle cx="15" cy="22" r="3" fill="none" stroke="white" stroke-width="1.5"/>
                    <!-- 中心点 -->
                    <circle cx="15" cy="15" r="2" fill="white"/>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }
        
        // 切换飞行状态
        function toggleFlight() {
            if (isPlaying) {
                pauseFlight();
            } else {
                startFlight();
            }
        }
        
        // 开始飞行
        function startFlight() {
            if (!routeData.waypoints || routeData.waypoints.length < 2) {
                alert('航点数量不足，无法开始飞行');
                return;
            }
            
            isPlaying = true;
            currentWaypointIndex = 0;
            
            document.getElementById('playBtn').textContent = '暂停飞行';
            document.getElementById('playBtn').classList.add('active');
            document.getElementById('flightStatus').textContent = '飞行中';
            
            // 开始飞行动画
            startFlightAnimation();
            
            console.log('Flight started');
        }
        
        // 暂停飞行
        function pauseFlight() {
            isPlaying = false;
            
            document.getElementById('playBtn').textContent = '开始飞行';
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('flightStatus').textContent = '已暂停';
            
            if (flightTimer) {
                clearInterval(flightTimer);
                flightTimer = null;
            }
            
            console.log('Flight paused');
        }
        
        // 开始飞行动画
        function startFlightAnimation() {
            const totalWaypoints = routeData.waypoints.length;
            const flightDuration = totalWaypoints * 3 * 1000; // 每个航点3秒
            const interval = 100; // 更新间隔100ms
            
            let progress = 0;
            
            flightTimer = setInterval(() => {
                if (!isPlaying) return;
                
                progress += interval;
                const totalProgress = progress / flightDuration;
                
                if (totalProgress >= 1) {
                    // 飞行完成
                    completeFlight();
                    return;
                }
                
                // 计算当前航点索引
                const waypointProgress = totalProgress * (totalWaypoints - 1);
                const currentIndex = Math.floor(waypointProgress);
                const nextIndex = Math.min(currentIndex + 1, totalWaypoints - 1);
                const segmentProgress = waypointProgress - currentIndex;
                
                // 更新无人机位置
                updateDronePosition(currentIndex, nextIndex, segmentProgress);
                
                // 更新信息面板
                updateFlightInfo(currentIndex, segmentProgress);
                
            }, interval);
        }
        
        // 更新无人机位置
        function updateDronePosition(currentIndex, nextIndex, segmentProgress) {
            if (!droneMarker || !routeData.waypoints) return;
            
            const currentWp = routeData.waypoints[currentIndex];
            const nextWp = routeData.waypoints[nextIndex];
            
            // 插值计算当前位置
            const lat = currentWp.latitude + (nextWp.latitude - currentWp.latitude) * segmentProgress;
            const lng = currentWp.longitude + (nextWp.longitude - currentWp.longitude) * segmentProgress;
            const alt = currentWp.altitude + (nextWp.altitude - currentWp.altitude) * segmentProgress;
            
            // 更新无人机位置
            droneMarker.setGeometries([{
                id: 'drone_marker',
                styleId: 'drone',
                position: new TMap.LatLng(lat, lng)
            }]);
            
            // 更新摄像机视角
            if (currentView === 'follow') {
                map.setCenter(new TMap.LatLng(lat, lng));
            }
        }
        
        // 更新飞行信息
        function updateFlightInfo(currentIndex, segmentProgress) {
            const currentWp = routeData.waypoints[currentIndex];
            const nextWp = routeData.waypoints[Math.min(currentIndex + 1, routeData.waypoints.length - 1)];
            
            // 计算当前高度
            const altitude = currentWp.altitude + (nextWp.altitude - currentWp.altitude) * segmentProgress;
            
            // 计算飞行速度
            const speed = 15 * speedLevel; // 基础速度15m/s
            
            // 计算剩余时间
            const remainingWaypoints = routeData.waypoints.length - currentIndex - 1;
            const remainingTime = remainingWaypoints * 3 / speedLevel; // 每个航点3秒
            
            // 更新UI
            document.getElementById('currentWaypoint').textContent = `${currentIndex + 1}/${routeData.waypoints.length}`;
            document.getElementById('altitude').textContent = `${Math.round(altitude)}m`;
            document.getElementById('speed').textContent = `${Math.round(speed)}m/s`;
            document.getElementById('remainingTime').textContent = `${Math.round(remainingTime)}s`;
        }
        
        // 完成飞行
        function completeFlight() {
            isPlaying = false;
            
            document.getElementById('playBtn').textContent = '重新飞行';
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('flightStatus').textContent = '飞行完成';
            
            if (flightTimer) {
                clearInterval(flightTimer);
                flightTimer = null;
            }
            
            // 显示完成提示
            setTimeout(() => {
                alert('飞行预览完成！');
            }, 500);
            
            console.log('Flight completed');
        }
        
        // 重置视角
        function resetView() {
            if (!map) return;
            
             const center = routeData.waypoints && routeData.waypoints.length > 0 
                 ? new TMap.LatLng(routeData.waypoints[0].latitude, routeData.waypoints[0].longitude)
                 : new TMap.LatLng(35.09260704247744, 111.06575713601103);
            
            map.setCenter(center);
            map.setZoom(16);
            map.setPitch(45);
            map.setRotation(0);
            
            console.log('View reset');
        }
        
        // 切换视角
        function toggleView() {
            if (!map) return;
            
            switch (currentView) {
                case 'god':
                    currentView = 'follow';
                    map.setPitch(30);
                    console.log('Switched to follow view');
                    break;
                case 'follow':
                    currentView = 'fpv';
                    map.setPitch(0);
                    console.log('Switched to FPV view');
                    break;
                case 'fpv':
                    currentView = 'god';
                    map.setPitch(45);
                    console.log('Switched to god view');
                    break;
            }
        }
        
        // 调整速度
        function toggleSpeed() {
            switch (speedLevel) {
                case 1:
                    speedLevel = 2;
                    console.log('Speed: Fast (2x)');
                    break;
                case 2:
                    speedLevel = 0.5;
                    console.log('Speed: Slow (0.5x)');
                    break;
                case 0.5:
                    speedLevel = 1;
                    console.log('Speed: Normal (1x)');
                    break;
            }
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('div').textContent = message;
        }
        
        // 隐藏加载
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (flightTimer) {
                clearInterval(flightTimer);
            }
        });
        
        // ==================== 模式切换函数 ====================
        
        // 切换到编辑模式
        function switchToEditMode() {
            editMode = true;
            updateModeUI();
            updateEditControls();
        }
        
        // 切换到预览模式
        function switchToPreviewMode() {
            editMode = false;
            updateModeUI();
            updateEditControls();
        }
        
        // 更新模式UI显示
        function updateModeUI() {
            const editModeBtn = document.getElementById('editModeBtn');
            const previewModeBtn = document.getElementById('previewModeBtn');
            const editInfoPanel = document.getElementById('editInfoPanel');
            const previewInfoPanel = document.getElementById('previewInfoPanel');
            
            if (editMode) {
                editModeBtn.classList.add('active');
                previewModeBtn.classList.remove('active');
                editInfoPanel.style.display = 'block';
                previewInfoPanel.style.display = 'none';
            } else {
                editModeBtn.classList.remove('active');
                previewModeBtn.classList.add('active');
                editInfoPanel.style.display = 'none';
                previewInfoPanel.style.display = 'block';
            }
        }
        
        // ==================== 编辑模式相关函数 ====================
        
        // 更新编辑控制面板显示
        function updateEditControls() {
            const editControls = document.getElementById('editControls');
            const previewControls = document.getElementById('previewControls');
            
            if (editMode) {
                editControls.style.display = 'block';
                previewControls.style.display = 'none';
            } else {
                editControls.style.display = 'none';
                previewControls.style.display = 'block';
            }
        }
        
        // 添加航点（点击地图）
        function addWaypoint() {
            if (!editMode) return;
            
            // 移除之前的点击事件监听（避免重复绑定）
            map.off('click', onMapClick);
            
            // 添加地图点击事件监听
            map.on('click', onMapClick);
            
            // 显示提示
            showEditHint('点击地图添加航点');
            
            console.log('Map click listener added for waypoint creation');
        }
        
        // 地图点击事件
        function onMapClick(event) {
            if (!editMode) return;
            
            const latlng = event.latlng;
            const waypoint = {
                latitude: latlng.lat,
                longitude: latlng.lng,
                altitude: 100 + Math.random() * 50, // 随机高度
                name: `航点${waypoints.length + 1}`
            };
            
            waypoints.push(waypoint);
            addWaypointToMap(waypoint);
            updateFlightPath();
            updateWaypointsList(); // 更新航点列表
            
            // 移除点击事件监听
            map.off('click', onMapClick);
            hideEditHint();
            
            // 更新路线信息
            updateRouteInfo();
            
            console.log('Added waypoint:', waypoint);
        }
        
        // 在地图上添加航点标记
        function addWaypointToMap(waypoint) {
            const marker = new TMap.MultiMarker({
                map: map,
                styles: {
                    'waypoint': new TMap.MarkerStyle({
                        width: 30,
                        height: 30,
                        anchor: { x: 15, y: 15 },
                        src: createWaypointIcon(waypoints.length)
                    })
                },
                geometries: [{
                    id: `waypoint_${waypoints.length}`,
                    styleId: 'waypoint',
                    position: new TMap.LatLng(waypoint.latitude, waypoint.longitude)
                }]
            });
            
            waypointMarkers.push(marker);
        }
        
        // 更新飞行路径
        function updateFlightPath() {
            if (waypoints.length < 2) return;
            
            // 清除现有路径
            if (flightPath) {
                flightPath.setMap(null);
            }
            
            // 创建新路径
            const path = waypoints.map(wp => new TMap.LatLng(wp.latitude, wp.longitude));
            
            flightPath = new TMap.MultiPolyline({
                map: map,
                styles: {
                    'flight': new TMap.PolylineStyle({
                        color: '#FF6B6B',
                        width: 4,
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    })
                },
                geometries: [{
                    id: 'flight_path',
                    styleId: 'flight',
                    paths: [path]
                }]
            });
        }
        
        // 清空所有航点
        function clearWaypoints() {
            if (!editMode) return;
            
            waypoints = [];
            
            // 清除地图上的标记
            waypointMarkers.forEach(marker => marker.setMap(null));
            waypointMarkers = [];
            
            // 清除飞行路径
            if (flightPath) {
                flightPath.setMap(null);
                flightPath = null;
            }
            
            // 更新航点列表
            updateWaypointsList();
            
            // 更新路线信息
            updateRouteInfo();
            
            console.log('Cleared all waypoints');
        }
        
        // 完成编辑
        function finishEditing() {
            if (!editMode) return;
            
            if (waypoints.length < 2) {
                alert('至少需要2个航点才能完成编辑');
                return;
            }
            
            const routeData = {
                waypoints: waypoints,
                routeName: '自定义3D路线',
                timestamp: Date.now()
            };
            
            // 发送到小程序
            sendToMiniProgram({
                action: 'route_edited',
                data: routeData
            });
            
            console.log('Route editing completed:', routeData);
        }
        
        // 发送消息到小程序
        function sendToMiniProgram(data) {
            if (window.wx && window.wx.miniProgram) {
                window.wx.miniProgram.postMessage({
                    data: data
                });
                console.log('Message sent to MiniProgram:', data);
            } else {
                console.warn('MiniProgram API not available');
            }
        }
        
        // 显示编辑提示
        function showEditHint(message) {
            // 创建提示元素
            let hint = document.getElementById('editHint');
            if (!hint) {
                hint = document.createElement('div');
                hint.id = 'editHint';
                hint.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(hint);
            }
            hint.textContent = message;
            hint.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                hint.style.display = 'none';
            }, 3000);
        }
        
        // 隐藏编辑提示
        function hideEditHint() {
            const hint = document.getElementById('editHint');
            if (hint) {
                hint.style.display = 'none';
            }
        }

        // 显示现有航点（编辑模式）
        function addExistingWaypoints() {
            if (!editMode || !waypoints || waypoints.length === 0) return;
            
            console.log('Adding existing waypoints:', waypoints);
            
            // 清除现有标记
            waypointMarkers.forEach(marker => marker.setMap(null));
            waypointMarkers = [];
            
            // 添加航点标记
            waypoints.forEach((waypoint, index) => {
                addWaypointToMap(waypoint);
            });
            
            // 更新飞行路径
            updateFlightPath();
            
            // 更新航点列表
            updateWaypointsList();
            
            // 更新路线信息
            updateRouteInfo();
        }

        // 更新航点列表显示
        function updateWaypointsList() {
            const waypointsList = document.getElementById('waypointsList');
            const waypointCount = document.getElementById('waypointCount');
            
            if (!waypointsList || !waypointCount) return;
            
            // 更新航点数量
            waypointCount.textContent = `共${waypoints.length}个航点`;
            
            // 清空现有列表
            waypointsList.innerHTML = '';
            
            // 生成航点列表
            waypoints.forEach((waypoint, index) => {
                const waypointItem = document.createElement('div');
                waypointItem.className = 'waypoint-item';
                waypointItem.innerHTML = `
                    <div class="waypoint-number">${index + 1}</div>
                    <div class="waypoint-info">
                        <div class="waypoint-name">${waypoint.name || `航点${index + 1}`}</div>
                        <div class="waypoint-coords">经度: ${waypoint.longitude.toFixed(6)}</div>
                        <div class="waypoint-coords">纬度: ${waypoint.latitude.toFixed(6)}</div>
                        <div class="waypoint-altitude">高度: ${waypoint.altitude}m</div>
                    </div>
                    ${editMode ? `<div class="waypoint-delete" onclick="deleteWaypoint(${index})">删除</div>` : ''}
                `;
                
                // 添加点击事件（非编辑模式）
                if (!editMode) {
                    waypointItem.addEventListener('click', () => {
                        focusOnWaypoint(index);
                    });
                }
                
                waypointsList.appendChild(waypointItem);
            });
        }

        // 聚焦到指定航点
        function focusOnWaypoint(index) {
            if (index < 0 || index >= waypoints.length) return;
            
            const waypoint = waypoints[index];
            const latlng = new TMap.LatLng(waypoint.latitude, waypoint.longitude);
            
            // 移动地图中心到该航点
            map.setCenter(latlng);
            map.setZoom(18);
            
            console.log('Focused on waypoint:', waypoint);
        }

        // 删除航点
        function deleteWaypoint(index) {
            if (!editMode || index < 0 || index >= waypoints.length) return;
            
            // 从数组中删除
            waypoints.splice(index, 1);
            
            // 重新渲染地图标记
            waypointMarkers.forEach(marker => marker.setMap(null));
            waypointMarkers = [];
            
            waypoints.forEach((waypoint, i) => {
                addWaypointToMap(waypoint);
            });
            
            // 更新飞行路径
            updateFlightPath();
            
            // 更新航点列表
            updateWaypointsList();
            
            // 更新路线信息
            updateRouteInfo();
            
            console.log('Deleted waypoint at index:', index);
        }

        // 更新路线信息显示
        function updateRouteInfo() {
            const routeName = document.getElementById('routeName');
            const routeWaypointCount = document.getElementById('routeWaypointCount');
            const routeDistance = document.getElementById('routeDistance');
            const routeDuration = document.getElementById('routeDuration');
            
            if (!routeName || !routeWaypointCount || !routeDistance || !routeDuration) return;
            
            // 更新路线名称
            routeName.textContent = routeData.routeName || '未命名路线';
            
            // 更新航点数量
            routeWaypointCount.textContent = waypoints.length;
            
            // 计算总距离
            const totalDistance = calculateTotalDistance();
            routeDistance.textContent = totalDistance > 0 ? `${totalDistance.toFixed(2)}km` : '-';
            
            // 计算预计时长（假设平均速度30km/h）
            const estimatedDuration = totalDistance > 0 ? Math.round(totalDistance / 30 * 60) : 0;
            routeDuration.textContent = estimatedDuration > 0 ? `${estimatedDuration}分钟` : '-';
        }

        // 计算总距离
        function calculateTotalDistance() {
            if (waypoints.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                const distance = calculateDistance(
                    waypoints[i].latitude, waypoints[i].longitude,
                    waypoints[i + 1].latitude, waypoints[i + 1].longitude
                );
                totalDistance += distance;
            }
            
            return totalDistance;
        }

        // 计算两点间距离（公里）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半径（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>


